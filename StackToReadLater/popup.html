<head>
<style>
body {
  overflow: hidden;
  margin: 0px;
  padding: 0px;
  background: #ffffff;
}

div.row {
  width: 250px;
  height: 20px;
}

a.x {
  cursor: pointer;
  width: 18px;
  float: left;
  text-align: center;
}

div.link {
  cursor: pointer;
  padding: 1px 1px 1px 1px;
  font-family: sans-serif;
  font-size: 0.8em;
  height: 16px;
  margin-top: 1px;
}
div.link:hover {
  background: #e6e6fa;
}

img {
  float: left;
}

a.link {
  width: 213px;
  text-decoration: none;;
  float: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

div.clear {
  width: 50px;
  clear: left;
  cursor: pointer;
  font-family: sans-serif;
  font-size: 0.8em;
  text-align: center;
}
div.clear:hover {
  background: #ff6347
}

#sortable-list {
    list-style-type: none;
    margin: 0;
    padding: 0;
    width: 70%;
}
#sortable-list li {
    margin: 0 3px 3px 3px;
    padding: 0.3em;
    padding-left: 1em;
    font-size: 15px;
    font-weight: bold;
    cursor: move;
}

</style>

<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jquery-ui.custom.min.js"></script>

<script>

//リストクリア
function clearList() {
    localStorage.removeItem("list");  // ローカルストレージクリア
    chrome.browserAction.setBadgeText({text:""}); // バッジクリア
    window.close(); // popup閉じ
}

//アイテムクリア
function clearItem(id) {

    // ローカルストレージから削除
    var list = JSON.parse(localStorage.getItem("list"));
    for (var i = 0; i < list.length; i++) {
        if (id == list[i].id) {
            list.splice(i, 1);
            console.log("delete item is ...\n" + list[i] +  "]");
            break;
        }
    }
    localStorage.setItem("list", JSON.stringify(list));

    // バッジ更新
    var text = "";
    console.log("list.length = " + list.length);
    if (0 < list.length) {
      text = String(list.length);
    }
    chrome.browserAction.setBadgeText({text:text});

    // POPUP内から削除
    var deleteItem = document.getElementById(id);
    console.log(deleteItem);
    document.getElementById("sortable-list").removeChild(deleteItem);
}


// リンクリストを作成する
function makeList() {
    console.log("makeList()");
    var list = JSON.parse(localStorage.getItem("list"));
    if (/*typeof list == "undefined" || */list == null || list.length == 0) {
        // リストが空なら何も表示しない
        document.write("No item");
        return;
    }

    // リスト
    for (var i = 0; i < list.length; i++) {
        var item = list[i];

        // 削除ボタン
        var xTag = document.createElement("a");
        xTag.className = "x";
        xTag.appendChild(document.createTextNode("x"));
        xTag.setAttribute("onclick", "clearItem(" + item.id + ")");

        // Favicon
        var imgTag = document.createElement("img");
        imgTag.src = "chrome://favicon/" + item.url;

        // リンク
        var aTag = document.createElement("a");
        aTag.className = "link";
        console.log(JSON.stringify(item) + "\n");
        aTag.href = item.url;
        if (localStorage["autoRemove"] == "true") {
           // リンククリックで自動削除
            aTag.setAttribute("onclick", "clearItem(" + item.id + ")");
        }
        aTag.appendChild(document.createTextNode(item.title));

        // Favicon+リンク div
        var linkDivTag = document.createElement("div");
        linkDivTag.className = "link";
        linkDivTag.title = item.title + "\n" + item.url; // ポップアップでタイトルとURをL表示
        linkDivTag.appendChild(imgTag);
        linkDivTag.appendChild(aTag);

        // 削除ボタン ＋ (Favicon ＋ リンク div)
        var rowDivTag = document.createElement("div");
        rowDivTag.className = "row";
        if (true) { // TODO オプション
            rowDivTag.appendChild(xTag);
        }
        rowDivTag.appendChild(linkDivTag);

        // li
        var liTag = document.createElement("li");
        liTag.id = item.id; // clearItem()にて使用する
        liTag.className = "ui-state-default";
        liTag.appendChild(rowDivTag);
        document.getElementById("sortable-list").appendChild(liTag);
    }

    // この関数内に書くことで上記で動的生成されたdivタグにjQueryイベントを設定できる
    $(function(){
    	var mousedownX;
    	var mousedownY;

        // divマウスダウンハンドラ。マウス押下時の座標を記録しておく。
    	$("div.link").mousedown(function(e){
        	mousedownX = e.clientX;
        	mousedownY = e.clientY;
            return true;
        });

        // divクリックハンドラ。マウス押下時と同じ座標のみクリックとみなしリンクへ飛ばす。
        $("div.link").click(function(e){
            if (mousedownX == e.clientX && mousedownY == e.clientY) {
                var url = $(this).find("a").attr("href");
                window.open(url, "_blank");
                return false;
            } else {
            	return true; //D&Dによる並び替えはこっち
            }
        });

        // D&Dによる並べ替え
        $('#sortable-list').sortable();
        $('#sortable-list').disableSelection();

        // 削除ボタンのホバーで行の色を切り替える
        $("a.x").hover(
            function(){
                var liTag = $(this).parent().get(0);
                liTag.style.background = "#ff3333";
            },
            function(){
                var liTag = $(this).parent().get(0);
                liTag.style.background = "#ffffff";
            }
        );
    });
}

</script>
</head>

<body onload="makeList()">
    <!-- リスト  -->
    <ul id="sortable-list"></ul>
    <!-- クリアボタン  -->
    <!--
    <div id="buttonClear" class="clear" onclick="clearList()">CLEAR</div>
    -->
</body>